<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Node</title>
  </head>
  <body>
    <main id="editor">
      <nav>
        <h1>Editor</h1>
        <button id="help-button">Help</button>
      </nav>

      <p id="error-message" class="hidden">Select a text layer to get started.</p>

      <div id="editor-content" class="hidden">
        <div id="background-color" class="group">
          <h2>Background Color</h2>
          <div class="swatch">
            <div class="swatch-visual"></div>
            <div class="swatch-details">
              <span class="main-value"></span>
              <span class="sub-value"></span>
            </div>
          </div>
        </div>

        <div id="text-color" class="group">
          <h2>Text Color</h2>
          <div id="current-color">
            <h3>Current color</h3>
            <div class="swatch">
              <div class="swatch-visual small"></div>
              <div class="swatch-details">
                <span class="main-value"></span>
                <span class="sub-value"></span>
              </div>
            </div>
          </div>

          <div id="enabled-swatch" class="hidden">
            <div class="swatch">
              <div class="swatch-details">
                <span class="main-value">color-contrast()</span>
                <span class="sub-value">Automatically adjusting</span>
              </div>
            </div>
          </div>
          
          <div id="automatic-swatch">
            <h3>New color with color-contrast()</h3>
            <div>
              <div id="automatic-swatch-visual-white" class="swatch-visual">#FFFFFF</div>
              <div id="automatic-swatch-details">
                <span id="automatic-swatch-white-contrast-ratio" class="new-color-swatch-value">-</span>
                <span>vs</span>
                <span id="automatic-swatch-black-contrast-ratio" class="new-color-swatch-value">-</span>
              </div>
              <div id="automatic-swatch-visual-black" class="swatch-visual">#000000</div>
            </div>
          </div>
        </div>

        <button id="apply-color-contrast" class="hidden">Switch to color-contrast()</button>
        <button id="disable-color-contrast" class="hidden">Remove color-contrast()</button>
      </div>
    </main>
    <script>
      let textNodeData = null;
      let containerNodeData = null;

      const editorContentElement = document.querySelector('#editor-content');
      const errorMessageElement = document.querySelector('#error-message');
      
      const backgroundColorGroup = document.querySelector('#background-color');
      const backgroundSwatchVisualElement = backgroundColorGroup.querySelector('.swatch-visual');
      const backgroundMainValueElement = backgroundColorGroup.querySelector('.main-value');
      const backgroundSubValueElement = backgroundColorGroup.querySelector('.sub-value');

      const textColorGroup = document.querySelector('#text-color');
      const textSwatchVisualElement = textColorGroup.querySelector('.swatch-visual');
      const textMainValueElement = textColorGroup.querySelector('.main-value');
      const textSubValueElement = textColorGroup.querySelector('.sub-value');

      const automaticSwatchElement = document.querySelector('#automatic-swatch');
      const automaticSwatchVisualWhiteElement = automaticSwatchElement.querySelector('#automatic-swatch-visual-white');
      const automaticSwatchVisualBlackElement = automaticSwatchElement.querySelector('#automatic-swatch-visual-black');
      const automaticSwatchDetailsElement = automaticSwatchElement.querySelector('#automatic-swatch-details');
      const automaticSwatchWhiteContrastRatioElement = automaticSwatchElement.querySelector('#automatic-swatch-white-contrast-ratio');
      const automaticSwatchBlackContrastRatioElement = automaticSwatchElement.querySelector('#automatic-swatch-black-contrast-ratio');

      const enabledSwatchElement = document.querySelector('#enabled-swatch');
      const applyColorContrastButton = document.querySelector('#apply-color-contrast');
      const currentColorElement = document.querySelector('#current-color');
      const disableColorContrastButton = document.querySelector('#disable-color-contrast');

      function updateErrorState(message) {
        editorContentElement.classList.add('hidden');
        errorMessageElement.classList.remove('hidden');
        errorMessageElement.textContent = message;
      }

      function updateTextNodeState(data) {
        textNodeData = data.textNodeData;
        containerNodeData = data.containerNodeData;

        // Show the editor interface
        editorContentElement.classList.remove('hidden');
        errorMessageElement.classList.add('hidden');

        // Set the background color
        if (containerNodeData) {
          backgroundSwatchVisualElement.style.backgroundColor = containerNodeData.fillColor.hex;
          backgroundMainValueElement.textContent = containerNodeData.fillColor.hex;
          backgroundSubValueElement.textContent = containerNodeData.fillColor.variableName;
        }

        // Set the text color
        textSwatchVisualElement.style.backgroundColor = textNodeData.fillColor.hex;
        textMainValueElement.textContent = textNodeData.fillColor.hex;
        textSubValueElement.textContent = textNodeData.fillColor.variableName;

        // Check if color-contrast is enabled
        const isEnabled = textNodeData.pluginData?.enabled === true;
        
        // Show/hide appropriate sections based on enabled state
        enabledSwatchElement.classList.toggle('hidden', !isEnabled);
        currentColorElement.classList.toggle('hidden', isEnabled);
        automaticSwatchElement.querySelector('h3').classList.toggle('hidden', isEnabled);
        applyColorContrastButton.classList.toggle('hidden', isEnabled);
        disableColorContrastButton.classList.toggle('hidden', !isEnabled);

        // Update contrast values
        if (containerNodeData) {
          const whiteContrast = containerNodeData.colorContrast.white.toFixed(2);
          const blackContrast = containerNodeData.colorContrast.black.toFixed(2);
          
          automaticSwatchWhiteContrastRatioElement.textContent = `${whiteContrast}:1`;
          automaticSwatchBlackContrastRatioElement.textContent = `${blackContrast}:1`;

          if (containerNodeData.colorContrast.white > containerNodeData.colorContrast.black) {
            automaticSwatchWhiteContrastRatioElement.classList.add('largest');
            automaticSwatchBlackContrastRatioElement.classList.remove('largest');
          } else {
            automaticSwatchBlackContrastRatioElement.classList.add('largest');
            automaticSwatchWhiteContrastRatioElement.classList.remove('largest');
          }
        }
      }

      window.onmessage = async (event) => {
        const data = event.data.pluginMessage;
        console.log('Received message:', data);

        switch (data.type) {
          case 'SELECTION_CHANGE_TEXT_NODE':
            updateTextNodeState(data);
            break;

          case 'SELECTION_CHANGE_NO_NODE_SELECTED':
            updateErrorState(data.message || 'Select a text layer to get started.');
            break;

          case 'SELECTION_CHANGE_CONTAINER_NODE':
            updateErrorState('Select a text layer to get started.');
            break;
        }
      };

      document.getElementById('apply-color-contrast').addEventListener('click', () => {
        if (!containerNodeData || !textNodeData) {
          console.error('No container node or text node data available');
          return;
        }

        parent.postMessage({ pluginMessage: {
          type: 'ENABLE_COLOR_CONTRAST_ON_SELECTED_NODE',
          textNodeData: textNodeData,
          containerNodeData: containerNodeData
        }}, '*');
      });

      document.getElementById('disable-color-contrast').addEventListener('click', () => {
        if (!containerNodeData || !textNodeData) {
          console.error('No container node or text node data available');
          return;
        }

        parent.postMessage({ pluginMessage: {
          type: 'DISABLE_COLOR_CONTRAST_ON_SELECTED_NODE',
          textNodeData: textNodeData,
          containerNodeData: containerNodeData
        }}, '*');
      });

      document.getElementById('help-button').addEventListener('click', () => {
        parent.postMessage({ pluginMessage: {
          type: 'NAVIGATE',
          route: 'help'
        }}, '*');
      });
    </script>
  </body>
</html>
