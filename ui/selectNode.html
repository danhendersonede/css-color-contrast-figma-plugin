<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Select Node</title>
  </head>
  <body>
    <main>
      <hgroup>
        <h1>Select Node</h1>
        <p>Select a text node to get started</p>
      </hgroup>

      <div class="details">
        <div class="swatch-visual"></div>
        <div class="swatch-details">
          <span id="hex"></span>
          <div class="contrast-ratio" id="text-color-white"><div class="swatch-visual small"></div><span class="value"></span></div>
          <div class="contrast-ratio" id="text-color-black"><div class="swatch-visual small"></div><span class="value"></span></div>
        </div>
      </div>

      <button id="apply-color-contrast">Use color-contrast()</button>
    </main>
    <script>
      let contrastWhite = null;
      let contrastBlack = null;
      let textNodeData = null;
      let containerNodeData = null;

      window.onmessage = async (event) => {
        const data = event.data.pluginMessage;

        if (data.type === 'SELECTION_CHANGE_TEXT_NODE') {
          textNodeData = data.textNodeData;
          containerNodeData = data.containerNodeData;

          if (containerNodeData.fillColor.hex && containerNodeData.colorContrast.white && containerNodeData.colorContrast.black) {
            const swatchVisual = document.querySelector('.swatch-visual');
            const hexElement = document.querySelector('#hex');
            swatchVisual.style.backgroundColor = containerNodeData.fillColor.hex;
            hexElement.textContent = containerNodeData.fillColor.hex;

            contrastWhite = containerNodeData.colorContrast.white;
            contrastBlack = containerNodeData.colorContrast.black;

            if (contrastWhite > contrastBlack) {
              document.querySelector('#text-color-white .value').classList.add('largest');
              document.querySelector('#text-color-black .value').classList.remove('largest');
            } else {
              document.querySelector('#text-color-black .value').classList.add('largest');
              document.querySelector('#text-color-white .value').classList.remove('largest');
            }

            // Update the UI with contrast values
            document.querySelector('#text-color-white .value').textContent = 
              `${contrastWhite.toFixed(2)}:1`;
            document.querySelector('#text-color-black .value').textContent = 
              `${contrastBlack.toFixed(2)}:1`;

            // Set the background colors for the small swatches
            document.querySelector('#text-color-white .swatch-visual').style.backgroundColor = '#FFFFFF';
            document.querySelector('#text-color-black .swatch-visual').style.backgroundColor = '#000000';

          }
        }
        if (data.type === 'SELECTION_CHANGE_NO_NODE_SELECTED') {
          document.querySelector('#text-color-black .value').classList.remove('largest');
          document.querySelector('#text-color-white .value').classList.remove('largest');
          document.querySelector('#text-color-white .value').textContent = '';
          document.querySelector('#text-color-black .value').textContent = '';

          document.querySelector('#text-color-white .swatch-visual').style.backgroundColor = '';
          document.querySelector('#text-color-black .swatch-visual').style.backgroundColor = '';

          document.querySelector('#hex').textContent = '';
        }
        if (data.type === 'SELECTION_CHANGE_OTHER_NODE') {
          document.querySelector('#selectedNode').textContent = 'No text node selected';
        }
      };

      document.getElementById('apply-color-contrast').addEventListener('click', () => {
        if (!containerNodeData || !textNodeData) {
          console.error('No container node or text node data available');
          return;
        }

        parent.postMessage({ pluginMessage: {
          type: 'ENABLE_COLOR_CONTRAST_ON_SELECTED_NODE',
          textNodeData: textNodeData,
          containerNodeData: containerNodeData
        }}, '*');
      });
    </script>
  </body>
</html>
